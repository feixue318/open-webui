name: éƒ¨ç½²åˆ°æŠ±æŠ±è„¸ç©ºé—´
on:
  push:
    branches:
      - main # ä»…ä»…åœ¨ main åˆ†æ”¯æ¨é€æ—¶è¿è¡Œ
  workflow_dispatch:
  schedule:
    - cron: '3 50 * * 2' # æ¯å‘¨äºŒ5:50è¿è¡Œ

jobs:
  check-secret:
    runs-on: ubuntu-latest
    outputs:
      token-set: ${{ steps.check-key.outputs.defined }}
    steps:
      - id: check-key
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        if: "${{ env.HF_TOKEN != '' }}"
        run: echo "defined=true" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: [check-secret]
    if: needs.check-secret.outputs.token-set == 'true'
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_REPO: ${{ secrets.HF_REPO }}
      HF_USER: ${{ secrets.HF_USER }}
    steps:
      - name: æ£€å‡ºå­˜å‚¨åº“
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: ç§»é™¤æ—§çš„ .git é…ç½®å’Œåˆå§‹åŒ–æ–°çš„
        run: |
          git init --initial-branch=main
          git add .
          git commit -m "Initial commit: remove git history"
          git rm -rf --cached .
          git add .
          git commit -m "Initial commit: remove git history"
      - name: å°†YAMLæ·»åŠ åˆ°README.mdä¸­
        run: |
          echo "---" > temp_readme.md
          echo "title: Open WebUI" >> temp_readme.md
          echo "emoji: ğŸ³" >> temp_readme.md
          echo "colorFrom: purple" >> temp_readme.md
          echo "colorTo: gray" >> temp_readme.md
          echo "sdk: docker" >> temp_readme.md
          echo "app_port: 8080" >> temp_readme.md
          echo "---" >> temp_readme.md
          cat README.md >> temp_readme.md
          mv temp_readme.md README.md

      - name: é…ç½®git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      - name: è®¾ç½®Gitå¹¶æ¨é€åˆ°æŠ±æŠ±è„¸ç©ºé—´
        run: |
          git lfs install
          git lfs track "*.ttf"
          git lfs track "*.jpg"
          git add .
          git commit -m "GitHub deploy: Triggered by commit ${{ github.sha }} on branch ${{ github.ref }}"
          git push --force https://${HF_USER}:${HF_TOKEN}@huggingface.co/spaces/${HF_USER}/${HF_REPO} main
